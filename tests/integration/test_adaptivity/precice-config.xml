<?xml version="1.0"?>

<precice-configuration>

    <log>
	<sink type="stream" output="stdout"  filter= "%Severity% > debug" enabled="true" />
    </log>
  
  <solver-interface experimental="true" dimensions="3">
    
    <data:scalar name="macro-scalar-data"/>
    <data:vector name="macro-vector-data"/>
    <data:scalar name="micro-scalar-data"/>
    <data:vector name="micro-vector-data"/>
    <data:scalar name="micro_sim_time"/>
    <data:scalar name="active_state"/>

    <mesh name="macro-cube-mesh">
       <use-data name="macro-scalar-data"/>
       <use-data name="macro-vector-data"/>
       <use-data name="micro-scalar-data"/>
       <use-data name="micro-vector-data"/>
       <use-data name="micro_sim_time"/>
       <use-data name="active_state"/>
    </mesh>

    <participant name="macro-cube">
      <use-mesh name="macro-cube-mesh" provide="yes"/>
      <read-data name="micro-scalar-data" mesh="macro-cube-mesh"/>
      <read-data name="micro-vector-data" mesh="macro-cube-mesh"/>
      <write-data name="macro-scalar-data" mesh="macro-cube-mesh"/>
      <write-data name="macro-vector-data" mesh="macro-cube-mesh"/>
    </participant>

    <participant name="Micro-Manager">
      <use-mesh name="macro-cube-mesh" from="macro-cube" direct-access="true" safety-factor="0.0"/>
      <read-data name="macro-scalar-data" mesh="macro-cube-mesh"/>
      <read-data name="macro-vector-data" mesh="macro-cube-mesh"/>
      <write-data name="micro-scalar-data" mesh="macro-cube-mesh"/>
      <write-data name="micro-vector-data" mesh="macro-cube-mesh"/>
      <write-data name="micro_sim_time" mesh="macro-cube-mesh"/>
      <write-data name="active_state" mesh="macro-cube-mesh"/>
      <export:vtu directory="output"/>
    </participant>

    <m2n:sockets from="Micro-Manager" to="macro-cube"/>

    <coupling-scheme:parallel-implicit>
       <participants first="macro-cube" second="Micro-Manager"/>
       <max-time value="1.0"/>
       <time-window-size value="1.0"/>
       <max-iterations value="1"/>
       <exchange data="micro-scalar-data" mesh="macro-cube-mesh" from="Micro-Manager" to="macro-cube" initialize="yes"/>
       <exchange data="micro-vector-data" mesh="macro-cube-mesh" from="Micro-Manager" to="macro-cube" initialize="yes"/>
       <exchange data="macro-scalar-data" mesh="macro-cube-mesh" from="macro-cube" to="Micro-Manager" initialize="yes"/>
       <exchange data="macro-vector-data" mesh="macro-cube-mesh" from="macro-cube" to="Micro-Manager" initialize="yes"/>
       <relative-convergence-measure limit="1e-5" data="macro-scalar-data" mesh="macro-cube-mesh"/>
       <relative-convergence-measure limit="1e-5" data="macro-vector-data" mesh="macro-cube-mesh"/>
       <relative-convergence-measure limit="1e-5" data="micro-scalar-data" mesh="macro-cube-mesh"/>
       <relative-convergence-measure limit="1e-5" data="micro-vector-data" mesh="macro-cube-mesh"/>
       <acceleration:IQN-ILS>
          <data name="micro-scalar-data" mesh="macro-cube-mesh"/>
          <data name="micro-vector-data" mesh="macro-cube-mesh"/>
          <data name="macro-scalar-data" mesh="macro-cube-mesh"/>
          <data name="macro-vector-data" mesh="macro-cube-mesh"/>
          <preconditioner type="residual-sum"/>
          <initial-relaxation value="0.9"/>
          <max-used-iterations value="40"/>
          <time-windows-reused value="20"/>
          <filter type="QR2" limit="1e-2"/>
       </acceleration:IQN-ILS>
    </coupling-scheme:parallel-implicit>

  </solver-interface>
</precice-configuration>
